# Voting, Harberger and Futarchy Setup

## Front-end

1. After checking the code out, Go to the my-app directory
2. Make sure your code is up to date, if it's not, run `git pull`
3. Copy the .env.example to .env: current values should be suitable in all cases.
4. Run `npm i` to download all dependencies
5. Run `npm run build` to build the static app: it will generate a dist directory with the static files.
6. Copy the content of dist to your server root. For example, if you use apache2 on Linux, that would be /var/www/html and the command to run would be
`sudo cp -R dist/* /var/www/html`
7. Make sure your server has the right configuration to be accessible from wherever you need.
8. You might want a deploy.sh script to be run each time you need to update the front-end after code changes:

```
#!/bin/bash

npm i
npm run build
sudo cp -R dist/* /var/www/html
```

## Back-end

1. Check the code out, go to the api directory and copy .env.example to .env
2. Install postgres
3. Create a user for the app matching the credential in your .env file.
4. Create a database matching the db name specified in the .env database, assign to the db user the required privileges (must be done using postgres commands)
5. Generate the tables, running `db/database.sql`with psql.
6. Run `npm i` to download all dependencies
7. Run the server `node server.js`
8. Maybe can help having some scripts to automate the process in the api directory like:

---
## start.sh
```
#!/bin/bash

node server.js 1>app.log 2>app.err &
PID=$!
disown $PID
echo $PID > APP_SERVER.PID
```

Will run the server in the background and direct logs and errors to specific files, accessible with less in following mode:

`less +F app.log`

`less +F app.err`

---
## kill.sh
```
#!/bin/bash

cat APP_SERVER.PID | xargs kill -9
```
Kills the running instance

---
## restart.sh
```
#!/bin/bash

./kill.sh
./start.sh
```

Combines the two

---
## deploy.sh
```
#!/bin/bash

./kill.sh

npm i
git pull

./start.sh
```

Stops the server, updates the code, updates the libraries and start it afresh.

## Server

You need to have an appropriate configuration to run the server. See the following configuration for `yary.eu` as an example, running the application locally doesn't require an ssl certificate.
Note that the `/api` and `/wss` have to be set for the communication between browser and server to work.

```
server {

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /var/www/html;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;
    server_name yary.eu; # managed by Certbot


        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                # try_files $uri $uri/ =404;
                try_files $uri $uri/ /index.html;
        }

        location /api/ {
                proxy_pass http://localhost:3080/api/;
        }

        location /wss {
                proxy_pass http://localhost:3088;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "Upgrade";
                proxy_set_header Host $host;
        }

}

```

Try whenever possible to use automated action (see workflows)
